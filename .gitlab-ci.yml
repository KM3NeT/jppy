variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Pip's cache doesn't store the python packages
# https://pip.pypa.io/en/stable/reference/pip_install/#caching
#
# If you want to also cache the installed packages, you have to install
# them in a virtualenv and cache it as well.
cache:
  paths:
    - .cache/pip
    - venv/
  key: "$CI_COMMIT_REF_SLUG"


stages:
  - init
  - build
  - test
  - doc
  - release


.virtualenv_template: &virtualenv_definition |
  pip install -U pip setuptools wheel
  python -m venv venv
  source venv/bin/activate
  pip install .


.junit_template: &junit_definition
    artifacts:
      reports:
        junit: "reports/junit*.xml"


download-pdfs:
    image: docker.km3net.de/base/ci-helper:1
    stage: init
    script:
        - '[ ! -d "pdfs" ] && mkdir pdfs && cd pdfs && for i in {1..6}; do wget "http://pi1139.physik.uni-erlangen.de/data/latest/J${i}j.dat" ; done'
    artifacts:
      paths:
        - pdfs

build-jpp-master:
    image: docker.km3net.de/base/python:3.8
    stage: build
    script:
        - *virtualenv_definition
        - ls -al pdfs

test-jpp-12.1.0:
    image: docker.km3net.de/jpp:v12-1-0
    stage: test
    script:
        - *virtualenv_definition
        - "[ ! -d 'pdfs' ] && mkdir pdfs && JMakePDF.sh -W $(pwd)/pdfs -w http://pi1139.physik.uni-erlangen.de/data/latest/ -C"
        - pip install -U pytest
        - pytest
    cache:
        paths:
            - pdfs/

test-jpp-latest:
    image: docker.km3net.de/jpp:latest
    stage: test
    script:
        - *virtualenv_definition
        - "[ ! -d 'pdfs' ] && mkdir pdfs && JMakePDF.sh -W $(pwd)/pdfs -w http://pi1139.physik.uni-erlangen.de/data/latest/ -C"
        - pip install -U pytest
        - pytest
    cache:
        paths:
            - pdfs/


pages:
    image: docker.km3net.de/base/python:3.6
    stage: doc
    script:
        - pip install -U sphinx
        - cd docs && make clean && make html && cd ..
        - mv docs/_build/html public/
        - cp -R examples public/
    artifacts:
        paths:
            - public
    cache: {}
    only:
        - tags
        - master


pypi:
    image: docker.km3net.de/base/python:3
    stage: release
    cache: {}
    script:
        - pip install -U twine setuptools
        - python setup.py sdist
        - twine upload dist/*
    only:
        - tags
